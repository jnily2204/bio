<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mewo - Bio Platform</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Inter"', 'sans-serif'], display: ['"Be Vietnam Pro"', 'sans-serif'] },
                    colors: { brand: { 50: '#fff1f2', 100: '#ffe4e6', 500: '#f43f5e', 600: '#e11d48', 700: '#be123c', 900: '#881337' } },
                    animation: { 'fade-in': 'fadeIn 0.4s ease-out', 'slide-up': 'slideUp 0.4s ease-out' },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }, 
                        slideUp: { '0%': { transform: 'translateY(15px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; overflow-x: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .hidden { display: none !important; }
        
        .input-modern { @apply w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:border-brand-500 focus:ring-4 focus:ring-brand-100 transition-all outline-none text-slate-800 text-sm font-medium; }
        .btn-primary { @apply w-full py-3 bg-slate-900 hover:bg-slate-800 text-white rounded-xl font-bold shadow-lg transition active:scale-95 flex items-center justify-center gap-2; }
        .card-modern { @apply bg-white rounded-2xl border border-slate-200 shadow-sm p-5 relative transition-all; }
        
        .tab-btn { @apply px-6 py-2.5 text-sm font-bold text-slate-500 rounded-xl transition-all cursor-pointer text-center whitespace-nowrap; }
        .tab-btn.active { @apply bg-white text-slate-900 shadow-sm text-brand-600; }
        
        /* Phone Mockup */
        .phone-mockup {
            width: 320px; height: 660px;
            background: #fff;
            border-radius: 45px;
            border: 12px solid #1e293b;
            position: relative;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform-origin: center top;
        }
        .dynamic-island {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            width: 90px; height: 26px; background: #000; border-radius: 20px;
            z-index: 50;
        }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: white; padding: 12px 20px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-left: 4px solid #e11d48; margin-bottom: 10px; animation: slideIn 0.3s; font-size: 0.9rem; font-weight: 600; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body class="text-slate-800 antialiased h-screen flex flex-col overflow-hidden">

    <div id="toast-container"></div>

    <!-- MAIN APP -->
    <div id="app" class="flex-1 relative h-full w-full">
        
        <!-- === VIEW: LANDING === -->
        <div id="view-landing" class="view-section hidden h-full overflow-y-auto bg-[#fff1f2]">
            <nav class="p-6 flex justify-between items-center max-w-7xl mx-auto w-full">
                <div class="text-2xl font-black text-brand-600 tracking-tighter flex items-center gap-2"><i class="fas fa-cat"></i> Mewo</div>
                <div class="flex gap-3">
                    <button onclick="openAuthModal('login')" class="px-5 py-2 rounded-lg bg-white/50 hover:bg-white font-bold text-sm transition">Đăng nhập</button>
                    <button onclick="openAuthModal('register')" class="px-5 py-2 rounded-full bg-brand-600 text-white font-bold text-sm shadow-lg hover:bg-brand-700 transition">Đăng ký</button>
                </div>
            </nav>
            <div class="flex flex-col lg:flex-row items-center justify-center gap-10 px-6 py-10 max-w-6xl mx-auto">
                <div class="lg:w-1/2 text-center lg:text-left space-y-6">
                    <h1 class="text-5xl lg:text-7xl font-black leading-tight text-slate-900">Mọi kết nối.<br><span class="text-brand-500">Một link duy nhất.</span></h1>
                    <p class="text-lg text-slate-600 font-medium">Tạo trang Bio chuyên nghiệp chỉ trong 5 phút. Miễn phí trọn đời.</p>
                    <div class="flex flex-col sm:flex-row gap-3 max-w-md mx-auto lg:mx-0">
                        <div class="flex-1 bg-white p-3 rounded-xl border-2 border-transparent focus-within:border-brand-200 shadow-xl flex items-center">
                            <span class="font-bold text-slate-400 pl-2">mewo.life/</span>
                            <input id="landing-slug" type="text" placeholder="username" class="flex-1 bg-transparent outline-none font-bold text-slate-900 ml-1 lowercase">
                        </div>
                        <button onclick="claimUsername()" class="px-8 py-3 bg-brand-600 text-white rounded-xl font-bold shadow-xl hover:bg-brand-700 transition">Bắt đầu</button>
                    </div>
                </div>
                <div class="lg:w-1/2 flex justify-center perspective-1000">
                    <div class="phone-mockup border-slate-900 shadow-2xl transform rotate-y-12">
                        <div class="dynamic-island"></div>
                        <iframe src="about:blank" class="w-full h-full bg-slate-50" style="pointer-events: none;"></iframe>
                    </div>
                </div>
            </div>
        </div>

        <!-- === VIEW: DASHBOARD === -->
        <div id="view-dashboard" class="view-section hidden h-full flex flex-col bg-slate-50">
            <header class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center z-20">
                <div class="font-black text-xl text-brand-600 flex items-center gap-2"><i class="fas fa-cat"></i> Mewo</div>
                <div class="flex items-center gap-4">
                    <span id="user-email-display" class="text-xs font-bold text-slate-500 hidden sm:block">...</span>
                    <button onclick="handleLogout()" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 hover:bg-red-50 text-slate-600 hover:text-red-500 transition"><i class="fas fa-power-off"></i></button>
                </div>
            </header>
            
            <main class="flex-1 overflow-y-auto custom-scrollbar p-6">
                <div class="max-w-5xl mx-auto">
                    <div class="flex justify-between items-end mb-8">
                        <div><h2 class="text-2xl font-bold text-slate-900">Trang của bạn</h2><p class="text-sm text-slate-500">Quản lý các liên kết bio.</p></div>
                        <button onclick="openCreateModal()" class="px-5 py-2.5 bg-slate-900 text-white rounded-xl font-bold text-sm shadow-lg hover:bg-slate-800 transition flex items-center gap-2"><i class="fas fa-plus"></i> Tạo mới</button>
                    </div>
                    
                    <div id="dashboard-loader" class="text-center py-10 hidden"><div class="inline-block w-8 h-8 border-4 border-slate-200 border-t-brand-600 rounded-full animate-spin"></div></div>
                    <div id="bio-list" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3"></div>
                </div>
            </main>
        </div>

        <!-- === VIEW: EDITOR (FIXED LAYOUT) === -->
        <div id="view-editor" class="view-section hidden h-full flex overflow-hidden bg-slate-100">
            
            <!-- LEFT PANEL: Editor (FLEX-1 to grow) -->
            <aside class="flex-1 flex flex-col h-full bg-[#f9fafb] border-r border-slate-200 z-10 overflow-hidden relative">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-white sticky top-0 z-30">
                    <button onclick="goToDashboard()" class="text-slate-500 hover:text-slate-900 font-bold text-sm flex items-center gap-2"><i class="fas fa-arrow-left"></i> Dashboard</button>
                    <div class="flex gap-2">
                        <button onclick="toggleMobilePreview()" class="md:hidden w-9 h-9 bg-slate-100 rounded-full flex items-center justify-center"><i class="fas fa-eye"></i></button>
                        <button onclick="saveCurrentBio()" class="bg-slate-900 text-white px-5 py-2 rounded-full font-bold text-sm hover:bg-slate-800 shadow-md flex items-center gap-2 transition hover:scale-105 active:scale-95"><i class="fas fa-save"></i> Lưu</button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="px-6 pt-6 pb-2">
                    <div class="bg-slate-200 p-1.5 rounded-2xl flex gap-1 overflow-x-auto hide-scrollbar">
                        <div onclick="switchTab('links')" id="tab-links" class="tab-btn active">Liên kết</div>
                        <div onclick="switchTab('products')" id="tab-products" class="tab-btn">Cửa hàng</div>
                        <div onclick="switchTab('appearance')" id="tab-appearance" class="tab-btn">Giao diện</div>
                        <div onclick="switchTab('settings')" id="tab-settings" class="tab-btn">Cài đặt</div>
                    </div>
                </div>

                <!-- Scrollable Content -->
                <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-6">
                    <!-- URL Info -->
                    <div class="bg-blue-50 border border-blue-100 p-3 rounded-xl flex justify-between items-center">
                        <div class="flex items-center gap-2 overflow-hidden px-1">
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse shrink-0"></span>
                            <a id="editor-url-display" href="#" target="_blank" class="text-xs font-bold text-slate-700 hover:text-blue-600 truncate font-mono">...</a>
                        </div>
                        <div class="flex gap-1 shrink-0">
                            <button onclick="copyLink()" class="w-8 h-8 rounded-lg hover:bg-white/50 flex items-center justify-center text-slate-500"><i class="fas fa-copy"></i></button>
                            <button onclick="showQRCode()" class="w-8 h-8 rounded-lg hover:bg-white/50 flex items-center justify-center text-slate-500"><i class="fas fa-qrcode"></i></button>
                        </div>
                    </div>

                    <!-- TAB CONTENT CONTAINERS -->
                    <div id="content-links" class="tab-content space-y-4">
                        <button onclick="addLinkItem()" class="w-full py-4 bg-brand-600 hover:bg-brand-700 text-white rounded-2xl font-bold shadow-lg shadow-brand-500/20 transition flex items-center justify-center gap-2 transform active:scale-95"><i class="fas fa-plus-circle"></i> Thêm liên kết</button>
                        <div id="links-container" class="space-y-3 mt-4 pb-10"></div>
                    </div>
                    
                    <div id="content-products" class="tab-content hidden space-y-4">
                         <button onclick="addProductItem()" class="w-full py-4 bg-slate-800 hover:bg-slate-900 text-white rounded-2xl font-bold shadow-lg transition flex items-center justify-center gap-2 transform active:scale-95"><i class="fas fa-shopping-bag"></i> Thêm sản phẩm</button>
                         <div class="mt-2 text-[10px] text-slate-400 bg-slate-50 p-2 rounded">Mẹo: Tạo Link loại "Bộ sưu tập" bên tab Liên kết để nhóm sản phẩm.</div>
                         <div id="products-container" class="space-y-3 mt-4 pb-10"></div>
                    </div>

                    <div id="content-appearance" class="tab-content hidden space-y-6">
                        <div class="card-modern space-y-3">
                            <h3 class="text-xs font-bold uppercase text-slate-400">Hồ sơ</h3>
                            <div class="flex items-center gap-3">
                                <img id="editor-avatar-img" class="w-12 h-12 rounded-full border bg-slate-100 object-cover">
                                <input id="inp-avatar" oninput="updatePreview()" class="input-modern flex-1" placeholder="Link ảnh avatar...">
                            </div>
                            <input id="inp-name" oninput="updatePreview()" class="input-modern font-bold" placeholder="Tên hiển thị">
                            <textarea id="inp-bio" oninput="updatePreview()" class="input-modern" rows="2" placeholder="Tiểu sử..."></textarea>
                        </div>

                        <div class="space-y-2">
                            <h3 class="text-xs font-bold uppercase text-slate-400">Chủ đề (Theme)</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setTheme('default')" class="h-16 rounded-lg bg-gradient-to-br from-pink-300 to-rose-400 border-2 border-transparent hover:border-brand-600"></button>
                                <button onclick="setTheme('ocean')" class="h-16 rounded-lg bg-gradient-to-b from-blue-500 to-cyan-400 border-2 border-transparent hover:border-brand-600"></button>
                                <button onclick="setTheme('midnight')" class="h-16 rounded-lg bg-slate-900 border-2 border-transparent hover:border-brand-600"></button>
                                <button onclick="setTheme('forest')" class="h-16 rounded-lg bg-gradient-to-br from-emerald-600 to-teal-400 border-2 border-transparent hover:border-brand-600"></button>
                                <button onclick="setTheme('minimal')" class="h-16 rounded-lg bg-white border border-slate-200 hover:border-brand-600"></button>
                                <button onclick="setTheme('sunset')" class="h-16 rounded-lg bg-gradient-to-tr from-orange-400 to-pink-500 border-2 border-transparent hover:border-brand-600"></button>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <h3 class="text-xs font-bold uppercase text-slate-400">Kiểu nút</h3>
                            <div class="grid grid-cols-3 gap-2 bg-slate-200 p-1 rounded-xl">
                                <button onclick="setButtonStyle('rounded')" class="py-2 bg-white rounded-lg text-xs font-bold shadow-sm hover:text-brand-600 transition">Tròn</button>
                                <button onclick="setButtonStyle('soft')" class="py-2 bg-slate-200/50 text-slate-600 rounded-lg text-xs font-bold hover:bg-white hover:shadow-sm transition">Bo góc</button>
                                <button onclick="setButtonStyle('rect')" class="py-2 bg-slate-200/50 text-slate-600 rounded-lg text-xs font-bold hover:bg-white hover:shadow-sm transition">Vuông</button>
                            </div>
                        </div>
                    </div>

                    <div id="content-settings" class="tab-content hidden space-y-4">
                        <div class="card-modern space-y-3">
                            <h3 class="font-bold text-sm text-slate-900">Mạng xã hội</h3>
                            <div id="list-socials" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- RIGHT PANEL: Preview (Fixed Width) -->
            <div class="hidden md:flex w-[480px] bg-white border-l border-slate-200 flex-col items-center justify-center p-6 relative z-20">
                <div class="phone-mockup transform scale-[0.85] xl:scale-100 transition-transform">
                    <div class="dynamic-island"></div>
                    <iframe id="preview-frame" class="w-full h-full bg-white border-none"></iframe>
                </div>
                <div class="mt-6 text-xs font-bold text-slate-300 uppercase tracking-widest">Live Preview</div>
            </div>
        </div>

        <!-- === VIEW: PUBLIC === -->
        <div id="view-public" class="view-section hidden h-full w-full overflow-y-auto"></div>

    </div>

    <!-- MODALS -->
    <!-- Auth Modal -->
    <div id="modal-auth" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-fade-in relative">
            <button onclick="closeModal('modal-auth')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-800"><i class="fas fa-times"></i></button>
            <h2 class="text-xl font-bold text-center mb-6" id="auth-title">Đăng nhập</h2>
            
            <div class="flex bg-slate-100 p-1 rounded-xl mb-6">
                <button onclick="toggleAuthMode('login')" id="tab-login" class="flex-1 py-2 text-sm font-bold rounded-lg shadow-sm bg-white text-slate-900 transition">Đăng nhập</button>
                <button onclick="toggleAuthMode('register')" id="tab-register" class="flex-1 py-2 text-sm font-medium text-slate-500 hover:text-slate-700 transition">Đăng ký</button>
            </div>

            <form id="form-login" onsubmit="handleLogin(event)" class="space-y-3">
                <input id="login-email" type="email" placeholder="Email" class="input-modern" required>
                <input id="login-password" type="password" placeholder="Mật khẩu" class="input-modern" required>
                <button type="submit" class="btn-primary">Đăng nhập</button>
                <p class="text-center text-xs text-slate-500 mt-4">Chưa có tài khoản? <a href="#" onclick="toggleAuthMode('register')" class="text-brand-600 font-bold">Đăng ký</a></p>
            </form>

            <form id="form-register" onsubmit="handleRegister(event)" class="space-y-3 hidden">
                <input id="reg-email" type="email" placeholder="Email" class="input-modern" required>
                <input id="reg-password" type="password" placeholder="Mật khẩu (min 6)" class="input-modern" minlength="6" required>
                <button type="submit" class="btn-primary">Đăng ký</button>
                <p class="text-center text-xs text-slate-500 mt-4">Đã có tài khoản? <a href="#" onclick="toggleAuthMode('login')" class="text-brand-600 font-bold">Đăng nhập</a></p>
            </form>
            
            <div class="relative my-6"><div class="absolute inset-0 flex items-center"><div class="w-full border-t"></div></div><div class="relative flex justify-center text-xs text-slate-400 bg-white px-2">HOẶC</div></div>
            <button onclick="handleGoogleLogin()" class="w-full py-2.5 border rounded-xl flex items-center justify-center gap-2 hover:bg-slate-50 font-bold text-sm text-slate-700 transition"><img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5"> Google</button>
        </div>
    </div>

    <!-- Create Modal -->
    <div id="modal-create" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 animate-fade-in">
            <h3 class="font-bold text-lg mb-4">Tạo Mewo mới</h3>
            <div class="flex bg-slate-50 border rounded-lg overflow-hidden mb-4 items-center">
                <span class="pl-3 pr-1 text-slate-400 text-sm font-bold">mewo.life/</span>
                <input id="create-slug" placeholder="username" class="flex-1 p-3 bg-transparent outline-none font-bold text-sm lowercase text-slate-800">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-create')" class="px-4 py-2 text-sm font-bold text-slate-500 hover:bg-slate-100 rounded-lg">Hủy</button>
                <button onclick="createNewBio()" class="px-4 py-2 bg-brand-600 text-white text-sm font-bold rounded-lg hover:bg-brand-700" id="btn-create-action">Tạo ngay</button>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div id="modal-qr" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4" onclick="closeModal('modal-qr')">
        <div class="bg-white p-6 rounded-2xl text-center" onclick="event.stopPropagation()">
            <h3 class="font-bold mb-4">Mã QR của bạn</h3>
            <img id="qr-img" class="w-48 h-48 mx-auto border rounded-lg mb-4">
            <button onclick="closeModal('modal-qr')" class="w-full py-2 bg-slate-100 font-bold rounded-lg">Đóng</button>
        </div>
    </div>

    <!-- Mobile Preview Modal -->
    <div id="modal-mobile-preview" class="fixed inset-0 bg-black/90 z-[70] hidden flex flex-col items-center justify-center p-4">
        <button onclick="toggleMobilePreview()" class="absolute top-4 right-4 w-10 h-10 bg-white/20 rounded-full text-white"><i class="fas fa-times"></i></button>
        <div class="w-full h-full max-w-[340px] max-h-[650px] bg-white rounded-[30px] overflow-hidden">
            <iframe id="mobile-preview-frame" class="w-full h-full bg-white border-none"></iframe>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyAqndpG932fb8RfOUBDAf_Q4R-9llpUJlI", authDomain: "biolink-6e6ee.firebaseapp.com", projectId: "biolink-6e6ee", storageBucket: "biolink-6e6ee.firebasestorage.app", messagingSenderId: "232844523779", appId: "1:232844523779:web:a0bdf6e804892ca5c41136", measurementId: "G-2DSTF8HF5P" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        window.onerror = function(m) { console.error(m); showToast("Lỗi: "+m, "error"); };

        let currentUser = null, currentBioData = null, editingSlug = null;
        const socialPlatforms = ['facebook','instagram','tiktok','youtube','twitter','email'];

        // --- ROUTING & AUTH ---
        function handleRoute() {
            if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', handleRoute); return; }
            const hash = window.location.hash;
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            
            // Hide Modals on route change (except when needed)
            if(hash !== '' && hash !== '#') closeModal('modal-auth');

            if (hash.startsWith('#u/')) {
                // Public View
                document.getElementById('view-public').classList.remove('hidden');
                loadPublicBio(hash.split('/')[1]);
            } else if (hash === '#dashboard') {
                if (currentUser) {
                    document.getElementById('view-dashboard').classList.remove('hidden');
                    loadDashboard();
                } else {
                    window.location.hash = ''; // Redirect to landing
                }
            } else if (hash.startsWith('#edit/')) {
                if (currentUser) {
                    document.getElementById('view-editor').classList.remove('hidden');
                    loadEditor(hash.split('/')[1]);
                } else {
                    window.location.hash = '';
                }
            } else {
                // Landing Page
                if (currentUser) window.location.hash = '#dashboard';
                else document.getElementById('view-landing').classList.remove('hidden');
            }
        }
        window.addEventListener('hashchange', handleRoute);
        window.addEventListener('load', handleRoute);

        // --- AUTH ---
        auth.onAuthStateChanged(async user => {
            currentUser = user;
            if (user) {
                const emailEl = document.getElementById('user-email-display');
                if(emailEl) emailEl.textContent = user.email || 'User';
                if (!window.location.hash || window.location.hash === '#') window.location.hash = '#dashboard';
                else if (window.location.hash === '#dashboard') loadDashboard(); // Reload if already on dashboard
            } else {
                if (window.location.hash === '#dashboard' || window.location.hash.startsWith('#edit/')) window.location.hash = '';
            }
        });

        function openAuthModal(mode) {
            document.getElementById('modal-auth').classList.remove('hidden');
            toggleAuthMode(mode);
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function claimUsername() { openAuthModal('register'); setTimeout(()=>document.getElementById('reg-email').focus(), 100); }
        function toggleAuthMode(mode) {
            document.getElementById('form-login').classList.toggle('hidden', mode !== 'login');
            document.getElementById('form-register').classList.toggle('hidden', mode !== 'register');
            document.getElementById('auth-title').innerText = mode === 'login' ? 'Đăng nhập' : 'Tạo tài khoản';
            document.getElementById('tab-login').classList.toggle('active', mode === 'login');
            document.getElementById('tab-register').classList.toggle('active', mode === 'register');
        }

        async function handleLogin(e) { e.preventDefault(); authAction(auth.signInWithEmailAndPassword, 'login'); }
        async function handleRegister(e) { e.preventDefault(); authAction(auth.createUserWithEmailAndPassword, 'register'); }
        async function authAction(method, type) {
            const email = document.getElementById(type==='login'?'login-email':'reg-email').value;
            const pass = document.getElementById(type==='login'?'login-password':'reg-password').value;
            try { await method(email, pass); closeModal('modal-auth'); showToast("Thành công!", "success"); } 
            catch(err) { showToast("Lỗi: "+err.message, "error"); }
        }
        async function handleGoogleLogin() { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); closeModal('modal-auth'); } catch(e){ showToast(e.message, 'error'); } }
        function handleLogout() { auth.signOut(); showToast("Đã đăng xuất"); }

        // --- DASHBOARD ---
        async function loadDashboard() {
            const list = document.getElementById('bio-list');
            list.innerHTML = ''; 
            document.getElementById('dashboard-loader').classList.remove('hidden');

            try {
                const snap = await db.collection('bios').where('ownerId','==',currentUser.uid).get();
                let html = '';
                if(snap.empty) {
                     html = `<div class="col-span-full text-center py-20 opacity-50"><i class="fas fa-ghost text-4xl mb-2"></i><p>Chưa có trang nào</p></div>`;
                } else {
                    snap.forEach(d => {
                        const data = d.data();
                        html += `
                        <div class="card-modern cursor-pointer hover:border-brand-500 group" onclick="location.hash='#edit/${d.id}'">
                            <div class="flex items-center gap-4 mb-4">
                                <img src="${data.profile.avatar || 'https://ui-avatars.com/api/?background=random'}" class="w-14 h-14 rounded-full border bg-slate-100 object-cover">
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800 truncate max-w-[150px]">${data.profile.name}</h3>
                                    <div class="text-xs text-slate-400 font-mono">/${d.id}</div>
                                </div>
                            </div>
                            <div class="flex justify-between border-t pt-3 mt-2">
                                <div class="text-xs font-bold text-slate-400 uppercase">Views: <span class="text-slate-800 text-sm">${data.views||0}</span></div>
                                <div class="text-brand-600 font-bold text-xs group-hover:underline">Chỉnh sửa &rarr;</div>
                            </div>
                        </div>`;
                    });
                }
                list.innerHTML = html;
            } catch(e) { showToast(e.message, 'error'); } 
            finally { document.getElementById('dashboard-loader').classList.add('hidden'); }
        }

        function openCreateModal() { document.getElementById('modal-create').classList.remove('hidden'); }
        async function createNewBio() {
            const btn = document.getElementById('btn-create-action');
            if(btn.disabled) return;
            const slug = document.getElementById('create-slug').value.trim().toLowerCase();
            if(slug.length < 3) return showToast("Tên quá ngắn", "error");
            btn.disabled = true; btn.innerText = "...";
            
            try {
                const ref = db.collection('bios').doc(slug);
                if((await ref.get()).exists) return showToast("Tên đã tồn tại", "error");
                
                await ref.set({
                    ownerId: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    profile: { name: "New User", bio: "Welcome", avatar: `https://ui-avatars.com/api/?name=${slug}&background=random` },
                    links: [], products: [], theme: { id: 'default', buttonStyle: 'rounded' }, socials: {}, views: 0
                });
                
                closeModal('modal-create');
                loadDashboard();
                showToast("Tạo thành công!", "success");
            } catch(e) { showToast(e.message, 'error'); }
            finally { btn.disabled = false; btn.innerText = "Tạo ngay"; }
        }

        // --- EDITOR ---
        async function loadEditor(slug) {
            editingSlug = slug;
            document.getElementById('editor-url-display').innerText = `mewo.life/${slug}`;
            document.getElementById('editor-url-display').href = `#u/${slug}`;
            
            const doc = await db.collection('bios').doc(slug).get();
            if(!doc.exists) { window.location.hash = '#dashboard'; return; }
            
            currentBioData = doc.data();
            currentBioData.links = currentBioData.links || [];
            currentBioData.products = currentBioData.products || [];
            currentBioData.socials = currentBioData.socials || {};
            currentBioData.theme = currentBioData.theme || {id:'default'};

            // Bind Data
            document.getElementById('inp-name').value = currentBioData.profile.name;
            document.getElementById('inp-bio').value = currentBioData.profile.bio;
            document.getElementById('inp-avatar').value = currentBioData.profile.avatar;
            document.getElementById('img-avatar-preview').src = currentBioData.profile.avatar;

            renderEditorLinks();
            renderEditorProducts();
            renderSocials();
            switchTab('links');
            updatePreview();
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(`content-${t}`).classList.remove('hidden');
            ['links','products','appearance','settings'].forEach(k => {
                const btn = document.getElementById(`tab-${k}`);
                if(btn) btn.className = k===t ? 'tab-btn active' : 'tab-btn';
            });
        }

        // Render Functions (Clean & Robust)
        const esc = (t) => t ? t.replace(/"/g, '&quot;') : '';

        function renderEditorLinks() {
            const c = document.getElementById('links-container'); c.innerHTML='';
            currentBioData.links.forEach((l, i) => {
                c.innerHTML += `
                <div class="card-modern group">
                    <div class="absolute top-3 right-3 flex gap-2">
                        <select onchange="upLink(${i},'type',this.value)" class="text-xs border border-slate-200 rounded-lg p-1 bg-slate-50 outline-none"><option value="link" ${l.type!=='collection'?'selected':''}>Link</option><option value="collection" ${l.type==='collection'?'selected':''}>Bộ sưu tập</option></select>
                        <button onclick="rmLink(${i})" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                    <input value="${esc(l.title)}" oninput="upLink(${i},'title',this.value)" class="font-bold w-full outline-none mb-2" placeholder="Tiêu đề">
                    <input value="${esc(l.url)}" oninput="upLink(${i},'url',this.value)" class="text-xs w-full text-slate-500 outline-none" placeholder="https://...">
                </div>`;
            });
        }

        function renderEditorProducts() {
            const c = document.getElementById('products-container'); c.innerHTML='';
            const cols = currentBioData.links.filter(l=>l.type==='collection').map(l=>`<option value="${l.title}">${l.title}</option>`).join('');
            currentBioData.products.forEach((p, i) => {
                c.innerHTML += `
                <div class="card-modern flex gap-3">
                    <img src="${p.image||'https://placehold.co/100'}" class="w-16 h-16 rounded bg-slate-100 object-cover">
                    <div class="flex-1 space-y-1">
                        <input value="${esc(p.name)}" oninput="upProd(${i},'name',this.value)" class="font-bold w-full text-sm outline-none" placeholder="Tên SP">
                        <div class="flex gap-2">
                             <input value="${esc(p.price)}" oninput="upProd(${i},'price',this.value)" class="w-16 text-xs font-bold text-brand-600 outline-none bg-slate-50 px-1 rounded" placeholder="Giá">
                             <select onchange="upProd(${i},'collection',this.value)" class="text-xs border rounded w-full">${cols}<option value="" ${!p.collection?'selected':''}>Chọn BST...</option></select>
                        </div>
                        <input value="${esc(p.image)}" oninput="upProd(${i},'image',this.value)" class="text-[10px] w-full border-b" placeholder="Link ảnh">
                        <input value="${esc(p.link)}" oninput="upProd(${i},'link',this.value)" class="text-[10px] w-full border-b" placeholder="Link mua">
                    </div>
                    <button onclick="rmProd(${i})" class="text-slate-300 hover:text-red-500 self-start"><i class="fas fa-trash"></i></button>
                </div>`;
            });
        }
        
        function renderSocials() {
            const c = document.getElementById('socials-container'); c.innerHTML='';
            socialPlatforms.forEach(p => {
                c.innerHTML += `<div class="flex items-center gap-3 p-2 bg-slate-50 rounded-lg border border-slate-100"><i class="fab fa-${p==='email'?'google':p} text-slate-400 w-5 text-center"></i><input value="${currentBioData.socials[p]||''}" oninput="upSocial('${p}',this.value)" class="bg-transparent text-sm w-full outline-none" placeholder="${p} url..."></div>`
            });
        }

        // Data Update Helpers
        function addLinkItem() { currentBioData.links.push({title:'Link mới', url:'#', type:'link'}); renderEditorLinks(); updatePreview(); }
        function rmLink(i) { currentBioData.links.splice(i,1); renderEditorLinks(); updatePreview(); }
        function upLink(i,k,v) { currentBioData.links[i][k]=v; updatePreview(); }
        
        function addProductItem() { currentBioData.products.push({name:'Sản phẩm', price:'0đ', image:'', link:'#', collection:''}); renderEditorProducts(); updatePreview(); }
        function rmProd(i) { currentBioData.products.splice(i,1); renderEditorProducts(); updatePreview(); }
        function upProd(i,k,v) { currentBioData.products[i][k]=v; updatePreview(); }
        
        function upSocial(k,v) { currentBioData.socials[k]=v; updatePreview(); }
        function setTheme(id) { currentBioData.theme.id=id; updatePreview(); }
        function setButtonStyle(s) { if(!currentBioData.theme) currentBioData.theme={}; currentBioData.theme.buttonStyle=s; updatePreview(); }
        function goToDashboard() { window.location.hash = '#dashboard'; }

        function updatePreview() {
            // Update Profile State
            currentBioData.profile.name = document.getElementById('inp-name').value;
            currentBioData.profile.bio = document.getElementById('inp-bio').value;
            currentBioData.profile.avatar = document.getElementById('inp-avatar').value;
            document.getElementById('img-avatar-preview').src = currentBioData.profile.avatar;

            // Render Iframe
            const html = generatePublicHTML(currentBioData, true);
            const frames = [document.getElementById('preview-frame'), document.getElementById('mobile-preview-frame')];
            frames.forEach(f => {
                if(f) { const doc = f.contentDocument || f.contentWindow.document; doc.open(); doc.write(html); doc.close(); }
            });
        }
        
        async function saveCurrentBio() {
            try { await db.collection('bios').doc(editingSlug).update(currentBioData); showToast("Đã lưu!", "success"); } catch(e){ showToast(e.message, 'error'); }
        }
        
        function toggleMobilePreview() { const m=document.getElementById('modal-mobile-preview'); m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) updatePreview(); }
        function showQRCode() { document.getElementById('modal-qr').classList.remove('hidden'); document.getElementById('qr-img').src=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.origin+'/#u/'+editingSlug)}`; }
        
        // --- PUBLIC VIEW & RENDERER ---
        async function loadPublicBio(slug) {
            const container = document.getElementById('view-public');
            try {
                const doc = await db.collection('bios').doc(slug).get();
                if(!doc.exists) { container.innerHTML = '<div class="h-screen flex items-center justify-center">Trang không tồn tại</div>'; return; }
                window.publicProducts = doc.data().products || []; // Global for shop
                container.innerHTML = generatePublicHTML(doc.data(), false);
                
                // Analytics
                db.collection('bios').doc(slug).update({ views: firebase.firestore.FieldValue.increment(1) });
            } catch(e) { container.innerHTML = 'Lỗi: '+e.message; }
        }

        function generatePublicHTML(data, isPreview) {
            const theme = data.theme || {id:'default', buttonStyle:'rounded'};
            const radius = theme.buttonStyle==='rect'?'rounded-md':theme.buttonStyle==='soft'?'rounded-2xl':'rounded-full';
            const safeProducts = JSON.stringify(data.products || []).replace(/\\/g, '\\\\').replace(/"/g, '\\"');
            
            // Logic for Scripts (Shop & Collections)
            const script = `
            <script>
                const products = JSON.parse("${safeProducts}");
                function showShop(col) {
                    document.getElementById('main-view').style.display='none';
                    document.getElementById('shop-view').style.display='block';
                    document.getElementById('shop-title').innerText = col;
                    const grid = document.getElementById('prod-grid');
                    grid.innerHTML = products.filter(p=>p.collection===col).map(p=>\`<div class="bg-white rounded-lg overflow-hidden shadow-sm"><img src="\${p.image}" class="w-full h-32 object-cover bg-slate-100"><div class="p-2"><div class="font-bold text-xs truncate text-slate-800">\${p.name}</div><div class="flex justify-between items-center mt-1"><span class="text-xs font-bold text-red-500">\${p.price}</span><a href="\${p.link}" target="_blank" class="bg-black text-white text-[10px] px-2 py-1 rounded">Mua</a></div></div></div>\`).join('');
                    if(!grid.innerHTML) grid.innerHTML='<div class="col-span-2 text-center text-white opacity-50 py-10">Trống</div>';
                }
                function closeShop() {
                    document.getElementById('shop-view').style.display='none';
                    document.getElementById('main-view').style.display='block';
                }
            <\/script>`;

            // Generate Links HTML - Use Escaped Titles for onclick
            const links = (data.links||[]).map(l => {
                const safeTitle = l.title.replace(/"/g, '&quot;').replace(/'/g, "\\'");
                if(l.type === 'collection') {
                    const act = isPreview ? `showShop('${safeTitle}')` : `window.showShop('${safeTitle}')`;
                    return `<div onclick="${act}" class="cursor-pointer mb-3 p-4 bg-white/90 backdrop-blur rounded-full shadow-sm flex justify-between items-center hover:bg-white transition"><span class="font-bold text-sm pl-2 border-l-4 border-brand-500">${l.title}</span><i class="fas fa-chevron-right text-gray-400"></i></div>`;
                }
                return `<a href="${l.url}" target="_blank" class="block mb-3 p-4 bg-white/90 backdrop-blur rounded-full shadow-sm text-center font-bold text-sm hover:bg-white transition hover:-translate-y-1">${l.title}</a>`;
            }).join('');
            
            const socials = Object.entries(data.socials||{}).map(([k,v]) => v ? `<a href="${v}" target="_blank" class="text-2xl text-white/90 hover:text-white transition"><i class="fab fa-${k==='email'?'google':k}"></i></a>` : '').join('');

            const css = `
                body{margin:0;font-family:sans-serif} ::-webkit-scrollbar{width:0}
                .theme-default{background:linear-gradient(45deg, #ff9a9e, #fad0c4)}
                .theme-ocean{background:linear-gradient(to bottom, #2193b0, #6dd5ed)}
                .theme-midnight{background:#111;color:#fff}
                .theme-forest{background:linear-gradient(to right, #11998e, #38ef7d)}
                .theme-minimal{background:#f3f4f6;color:#333}
                .theme-sunset{background:linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)}
                .wrapper{min-height:100vh;padding:40px 20px;display:flex;flex-direction:column;align-items:center}
            `;

            const content = `
                <div class="wrapper theme-${theme.id}">
                    <div id="main-view" class="w-full max-w-md text-center">
                        <img src="${data.profile.avatar}" class="w-24 h-24 rounded-full border-4 border-white/30 shadow-xl mx-auto mb-4 object-cover" onerror="this.src='https://ui-avatars.com/api/?name=User'">
                        <h1 class="text-xl font-bold mb-1 text-white drop-shadow-md">${data.profile.name}</h1>
                        <p class="text-sm text-white/80 mb-6 font-medium whitespace-pre-line">${data.profile.bio}</p>
                        <div class="flex justify-center gap-4 mb-8">${socials}</div>
                        <div class="w-full text-left">${links}</div>
                    </div>

                    <div id="shop-view" class="w-full max-w-md hidden" style="display:none">
                        <div class="flex items-center gap-3 mb-4 text-white">
                            <button onclick="${isPreview?'closeShop()':'window.closeShop()'}" class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-arrow-left"></i></button>
                            <h2 class="font-bold text-lg" id="shop-title">Shop</h2>
                        </div>
                        <div id="prod-grid" class="grid grid-cols-2 gap-3"></div>
                    </div>
                    
                    ${!isPreview ? '<footer class="mt-auto pt-10 text-xs text-white/50">Powered by Mewo</footer>' : ''}
                </div>
                ${script}
            `;

            if(isPreview) return `<!DOCTYPE html><html><head><script src="https://cdn.tailwindcss.com"><\/script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><style>${css}</style></head><body>${content}</body></html>`;
            return `<style>${css}</style>${content}`;
        }
        
        // --- GLOBAL HELPERS (SPA MODE) ---
        window.showShop = function(col) {
            document.getElementById('main-view').style.display='none';
            document.getElementById('shop-view').style.display='block';
            document.getElementById('shop-title').innerText = col;
            const grid = document.getElementById('prod-grid');
            grid.innerHTML = window.publicProducts.filter(p => p.collection === col).map(p => `
                <div class="bg-white rounded-lg overflow-hidden shadow-sm">
                    <img src="${p.image}" class="w-full h-32 object-cover bg-slate-100">
                    <div class="p-2">
                        <div class="font-bold text-xs truncate text-slate-800">${p.name}</div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs font-bold text-red-500">${p.price}</span>
                            <a href="${p.link}" target="_blank" class="bg-black text-white text-[10px] px-2 py-1 rounded">Mua</a>
                        </div>
                    </div>
                </div>
            `).join('');
            if(!grid.innerHTML) grid.innerHTML='<div class="col-span-2 text-center text-white opacity-50 py-10">Trống</div>';
        };
        window.closeShop = function() {
            document.getElementById('shop-view').style.display='none';
            document.getElementById('main-view').style.display='block';
        };

        function showToast(m,t='info'){ const d=document.createElement('div');d.className='toast';d.innerText=m;document.getElementById('toast-container').appendChild(d);setTimeout(()=>d.remove(),3000); }
        function copyToClipboard(t){ navigator.clipboard.writeText(t).then(()=>showToast("Đã sao chép","success")); }
    </script>
</body>
</html>
