<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mewo - Bio Platform</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Inter"', '"Be Vietnam Pro"', 'sans-serif'], display: ['"Be Vietnam Pro"', 'sans-serif'], serif: ['"Playfair Display"', 'serif'] },
                    colors: { brand: { 50: '#fff1f2', 100: '#ffe4e6', 500: '#f43f5e', 600: '#e11d48', 700: '#be123c', 900: '#881337' } },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out', 'slide-up': 'slideUp 0.5s ease-out', 'float': 'float 6s infinite', 'heart-beat': 'heartBeat 1s infinite' },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }, 
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }, 
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }, 
                        heartBeat: { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.2)' } } 
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; min-height: 100vh; overflow-x: hidden; }
        
        /* Themes Definitions */
        .theme-default { background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); background-size: 400% 400%; animation: meshMove 15s ease infinite; color: white; }
        .theme-ocean { background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); color: white; }
        .theme-midnight { background-color: #000000; background-image: radial-gradient(#333 1px, transparent 1px); background-size: 30px 30px; color: white; }
        .theme-forest { background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%); color: white; }
        .theme-minimal { background-color: #f3f4f6; color: #1f2937; }
        .theme-sunset { background: linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%); color: #1e293b; }

        @keyframes meshMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* Button Styles */
        .btn-style-rounded { border-radius: 9999px; }
        .btn-style-rect { border-radius: 4px; }
        .btn-style-soft { border-radius: 16px; }
        
        /* UI Utils */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(0,0,0,0.05); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .hidden { display: none !important; }
        .input-modern { width: 100%; padding: 10px 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem; transition: all 0.2s; outline: none; }
        .input-modern:focus { border-color: #e11d48; box-shadow: 0 0 0 3px rgba(225, 29, 72, 0.1); background: white; }
        
        /* Cat SVG */
        .cat-paws { transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); transform-box: fill-box; transform-origin: center top; }
        .cat-heart { opacity: 0; transform: scale(0) translateY(10px); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: center; transform-box: fill-box; }
        .loving-it .cat-paws-left { transform: translate(10px, -25px) rotate(30deg); }
        .loving-it .cat-paws-right { transform: translate(-10px, -25px) rotate(-30deg); }
        .loving-it .cat-heart { opacity: 1; transform: scale(1.2) translateY(-5px); animation: heartBeat 1s infinite; }
        .covering-eyes .cat-paws-left { transform: translate(12px, -45px) rotate(10deg); }
        .covering-eyes .cat-paws-right { transform: translate(-12px, -45px) rotate(-10deg); }

        /* Toast */
        .toast { background: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); margin-bottom: 12px; border-left: 4px solid #e11d48; animation: slideInRight 0.4s; display: flex; align-items: center; gap: 10px; font-weight: 500; font-size: 0.9rem; position: fixed; top: 24px; right: 24px; z-index: 9999; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-brand-100 selection:text-brand-900">

    <div id="toast-container"></div>

    <div id="app" class="min-h-screen flex flex-col">
        
        <!-- AUTH VIEW -->
        <div id="view-auth" class="view-section hidden flex-grow min-h-screen flex flex-col lg:flex-row bg-white">
            <!-- Left Side Branding -->
            <div class="hidden lg:flex lg:w-1/2 bg-slate-900 relative overflow-hidden flex-col justify-between p-12 text-white">
                <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 24px 24px;"></div>
                <div class="relative z-10 flex items-center gap-3"><i class="fas fa-cat text-brand-500 text-2xl"></i> <span class="font-bold text-2xl">Mewo</span></div>
                <div class="relative z-10 max-w-md"><h2 class="text-5xl font-bold mb-6">Li√™n k·∫øt m·ªçi th·ª©.<br>M·ªôt n∆°i duy nh·∫•t.</h2><p class="text-slate-400 text-lg">N·ªÅn t·∫£ng Bio Link mi·ªÖn ph√≠, m·∫°nh m·∫Ω v√† cute nh·∫•t v≈© tr·ª•.</p></div>
                <div class="relative z-10 text-sm text-slate-500">¬© 2024 Mewo Inc.</div>
            </div>

            <!-- Right Side Auth Forms -->
            <div class="w-full lg:w-1/2 flex flex-col justify-center items-center p-6 bg-white relative">
                <div class="w-full max-w-sm">
                    <!-- Cat SVG -->
                    <div class="flex justify-center mb-4 h-28 relative" id="cat-container">
                        <svg viewBox="0 0 120 110" class="w-36 h-36">
                            <path d="M30 35 L15 5 Q35 10 45 30 Z" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="2" stroke-linejoin="round"/>
                            <path d="M90 35 L105 5 Q85 10 75 30 Z" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="2" stroke-linejoin="round"/>
                            <ellipse cx="60" cy="60" rx="45" ry="38" fill="#f8fafc" stroke="#cbd5e1" stroke-width="2.5"/>
                            <ellipse cx="35" cy="70" rx="6" ry="4" fill="#fda4af" opacity="0.6"/>
                            <ellipse cx="85" cy="70" rx="6" ry="4" fill="#fda4af" opacity="0.6"/>
                            <g class="cat-eyes">
                                <circle cx="40" cy="55" r="10" fill="white" stroke="#334155" stroke-width="2"/>
                                <circle id="pupil-left" class="cat-pupil" cx="40" cy="55" r="6" fill="#1e293b"/>
                                <circle cx="43" cy="52" r="2" fill="white"/>
                                <circle cx="80" cy="55" r="10" fill="white" stroke="#334155" stroke-width="2"/>
                                <circle id="pupil-right" class="cat-pupil" cx="80" cy="55" r="6" fill="#1e293b"/>
                                <circle cx="83" cy="52" r="2" fill="white"/>
                            </g>
                            <path d="M57 65 L63 65 L60 68 Z" fill="#fda4af"/>
                            <path d="M60 68 Q50 77 45 70 M60 68 Q70 77 75 70" fill="none" stroke="#334155" stroke-width="1.5" stroke-linecap="round"/>
                            <path class="cat-heart" d="M60 70 C60 60 52 60 52 67 C52 75 60 80 60 80 C60 80 68 75 68 67 C68 60 60 60 60 70" fill="#f43f5e" stroke="#be123c" stroke-width="1"/>
                            <g><ellipse class="cat-paws cat-paws-left" cx="25" cy="95" rx="10" ry="12" fill="#f8fafc" stroke="#cbd5e1" stroke-width="2"/><ellipse class="cat-paws cat-paws-right" cx="95" cy="95" rx="10" ry="12" fill="#f8fafc" stroke="#cbd5e1" stroke-width="2"/></g>
                        </svg>
                    </div>
                    
                    <!-- Main Auth Container -->
                    <div id="auth-main-container">
                        <div class="text-center mb-6"><h1 class="text-2xl font-bold text-slate-900">Xin ch√†o üëã</h1><p class="text-slate-500 text-sm">ƒêƒÉng nh·∫≠p ƒë·ªÉ qu·∫£n l√Ω Mewo c·ªßa b·∫°n.</p></div>
                        <div class="flex bg-slate-100 p-1 rounded-lg mb-6"><button onclick="toggleAuthMode('login')" id="tab-login" class="flex-1 py-2 text-sm font-bold rounded shadow-sm bg-white text-slate-900">ƒêƒÉng nh·∫≠p</button><button onclick="toggleAuthMode('register')" id="tab-register" class="flex-1 py-2 text-sm font-medium text-slate-500">ƒêƒÉng k√Ω</button></div>
                        
                        <!-- Login Form -->
                        <form id="form-login" onsubmit="handleLogin(event)" class="space-y-4">
                            <input type="email" id="login-email" placeholder="Email" class="input-modern track-input" required>
                            <input type="password" id="login-password" placeholder="M·∫≠t kh·∫©u" class="input-modern pass-input" required>
                            <button type="submit" class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700 transition flex justify-center gap-2"><span>ƒêƒÉng nh·∫≠p</span><div class="hidden w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" id="login-loader"></div></button>
                        </form>
                        
                        <!-- Register Form -->
                        <form id="form-register" onsubmit="handleRegister(event)" class="space-y-4 hidden">
                            <input type="email" id="reg-email" placeholder="Email" class="input-modern track-input" required>
                            <input type="password" id="reg-password" placeholder="M·∫≠t kh·∫©u (min 6 k√Ω t·ª±)" class="input-modern pass-input" minlength="6" required>
                            <button type="submit" class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700 transition flex justify-center gap-2"><span>ƒêƒÉng k√Ω</span><div class="hidden w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" id="reg-loader"></div></button>
                        </form>

                        <!-- Social Login Divider -->
                        <div class="relative my-6">
                            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>
                            <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-slate-500">Ho·∫∑c ti·∫øp t·ª•c v·ªõi</span></div>
                        </div>

                        <!-- Social Buttons -->
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="handleGoogleLogin()" class="flex items-center justify-center gap-2 py-2.5 border border-slate-200 rounded-lg hover:bg-slate-50 transition">
                                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5"> <span class="text-sm font-medium">Google</span>
                            </button>
                            <button onclick="switchAuthView('phone')" class="flex items-center justify-center gap-2 py-2.5 border border-slate-200 rounded-lg hover:bg-slate-50 transition">
                                <i class="fas fa-phone text-slate-600"></i> <span class="text-sm font-medium">S·ªë ƒëi·ªán tho·∫°i</span>
                            </button>
                        </div>
                    </div>

                    <!-- Phone Auth Container (Hidden by default) -->
                    <div id="auth-phone-container" class="hidden">
                        <button onclick="switchAuthView('main')" class="text-sm text-slate-500 hover:text-slate-900 mb-4 flex items-center gap-1"><i class="fas fa-arrow-left"></i> Quay l·∫°i</button>
                        <h2 class="text-xl font-bold mb-4">ƒêƒÉng nh·∫≠p b·∫±ng SƒêT</h2>
                        
                        <!-- Step 1: Input Phone -->
                        <div id="phone-step-1">
                            <div class="flex gap-2 mb-4">
                                <div class="w-20 p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-center text-sm font-bold flex items-center justify-center gap-1">üáªüá≥ +84</div>
                                <input type="tel" id="phone-input" placeholder="912345678" class="flex-1 input-modern" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                            </div>
                            <div id="recaptcha-container" class="mb-4"></div>
                            <button onclick="sendOTP()" class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700 transition mt-2" id="btn-send-otp">G·ª≠i m√£ x√°c th·ª±c</button>
                        </div>

                        <!-- Step 2: Input OTP -->
                        <div id="phone-step-2" class="hidden">
                            <p class="text-sm text-slate-500 mb-4">Nh·∫≠p m√£ OTP (6 s·ªë) ƒë√£ g·ª≠i ƒë·∫øn s·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n.</p>
                            <input type="text" id="otp-input" placeholder="123456" class="input-modern text-center tracking-widest text-lg font-bold mb-4" maxlength="6">
                            <button onclick="verifyOTP()" class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700 transition">X√°c nh·∫≠n</button>
                            <button onclick="switchAuthView('phone')" class="w-full text-slate-500 py-2 text-sm mt-2 hover:text-slate-700">G·ª≠i l·∫°i / ƒê·ªïi s·ªë</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="view-section hidden flex-grow bg-slate-50">
            <nav class="bg-white border-b border-slate-200 sticky top-0 z-30 px-6 py-3 flex justify-between items-center">
                <div class="flex items-center gap-2 text-brand-600 font-bold text-xl"><i class="fas fa-cat"></i> Mewo</div>
                <div class="flex items-center gap-4"><span id="user-email-display" class="text-sm font-medium text-slate-600 hidden sm:block"></span><button onclick="handleLogout()" class="text-slate-400 hover:text-red-500"><i class="fas fa-sign-out-alt"></i></button></div>
            </nav>
            <div class="max-w-5xl mx-auto p-6 animate-fade-in">
                <div class="flex justify-between items-center mb-8">
                    <div><h2 class="text-2xl font-bold text-slate-900">Trang Bio c·ªßa b·∫°n</h2><p class="text-slate-500 text-sm">Qu·∫£n l√Ω v√† theo d√µi hi·ªáu qu·∫£ ho·∫°t ƒë·ªông.</p></div>
                    <button onclick="openCreateModal()" class="bg-slate-900 text-white px-5 py-2.5 rounded-lg hover:bg-slate-800 transition font-bold text-sm shadow flex items-center gap-2"><i class="fas fa-plus"></i> T·∫°o m·ªõi</button>
                </div>
                <div id="bio-list" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3"></div>
                <div id="dashboard-loader" class="flex justify-center mt-10 hidden"><div class="w-8 h-8 border-2 border-slate-200 border-t-brand-600 rounded-full animate-spin"></div></div>
            </div>
        </div>

        <!-- EDITOR VIEW -->
        <div id="view-editor" class="view-section hidden flex-grow bg-slate-100 flex flex-col md:flex-row h-screen overflow-hidden">
            <!-- Left Panel -->
            <div class="w-full md:w-[450px] bg-white border-r border-slate-200 flex flex-col h-full z-20 shadow-xl animate-slide-up md:animate-none">
                <div class="px-5 py-3 border-b border-slate-100 flex justify-between items-center bg-white z-10">
                    <button onclick="goToDashboard()" class="text-slate-500 hover:text-slate-900 font-medium text-sm flex items-center gap-1"><i class="fas fa-chevron-left"></i> Dashboard</button>
                    <button onclick="saveCurrentBio()" class="bg-brand-600 text-white px-4 py-1.5 rounded-md font-bold text-sm hover:bg-brand-700 shadow flex items-center gap-2"><i class="fas fa-save"></i> L∆∞u</button>
                </div>
                
                <!-- Editor Tabs -->
                <div class="flex border-b border-slate-100 px-5 pt-2">
                    <button onclick="switchEditorTab('links')" id="tab-editor-links" class="flex-1 py-2 text-sm font-bold border-b-2 border-brand-600 text-brand-600">Li√™n k·∫øt</button>
                    <button onclick="switchEditorTab('products')" id="tab-editor-products" class="flex-1 py-2 text-sm font-medium text-slate-500 hover:text-slate-800">S·∫£n ph·∫©m</button>
                    <button onclick="switchEditorTab('appearance')" id="tab-editor-appearance" class="flex-1 py-2 text-sm font-medium text-slate-500 hover:text-slate-800">Giao di·ªán</button>
                </div>

                <div class="overflow-y-auto flex-1 p-5 space-y-6 custom-scrollbar bg-slate-50/50">
                    <!-- URL Info -->
                    <div class="bg-blue-50 px-4 py-2 rounded border border-blue-100 flex justify-between items-center">
                        <span class="text-xs text-blue-600 font-mono truncate max-w-[200px]" id="editor-url-display">...</span>
                        <div class="flex gap-2">
                            <a id="live-preview-link" href="#" target="_blank" class="text-blue-500 hover:text-blue-700"><i class="fas fa-external-link-alt"></i></a>
                        </div>
                    </div>

                    <!-- TAB 1: LINKS (Collections & Links) -->
                    <div id="editor-tab-links" class="editor-tab-content space-y-4">
                        <div class="flex justify-between items-center"><h3 class="font-bold text-slate-800 text-sm">Danh s√°ch li√™n k·∫øt</h3><button onclick="addLinkItem()" class="text-xs bg-slate-900 text-white px-3 py-1.5 rounded font-bold shadow-sm">+ Th√™m</button></div>
                        <div id="ed-links-list" class="space-y-3 pb-10"></div>
                    </div>

                    <!-- TAB 2: PRODUCTS (Affiliate) -->
                    <div id="editor-tab-products" class="editor-tab-content hidden space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-slate-800 text-sm">S·∫£n ph·∫©m ti·∫øp th·ªã</h3>
                            <button onclick="addProductItem()" class="text-xs bg-slate-900 text-white px-3 py-1.5 rounded font-bold shadow-sm">+ Th√™m SP</button>
                        </div>
                        <p class="text-xs text-slate-500 bg-slate-100 p-2 rounded">T·∫°o link lo·∫°i "B·ªô s∆∞u t·∫≠p" ·ªü tab Li√™n k·∫øt ƒë·ªÉ nh√≥m c√°c s·∫£n ph·∫©m n√†y.</p>
                        <div id="ed-products-list" class="space-y-3 pb-10"></div>
                    </div>

                    <!-- TAB 3: APPEARANCE -->
                    <div id="editor-tab-appearance" class="editor-tab-content hidden space-y-6">
                        <!-- Profile -->
                        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm space-y-3">
                            <h3 class="font-bold text-xs uppercase text-slate-400 mb-2">H·ªì s∆°</h3>
                            <div class="flex gap-3 items-center">
                                <img id="editor-avatar-preview" class="w-12 h-12 rounded-full bg-slate-100 object-cover border">
                                <input type="text" id="ed-avatar" oninput="updatePreview()" placeholder="URL ·∫¢nh ƒë·∫°i di·ªán" class="input-modern flex-1">
                            </div>
                            <input type="text" id="ed-name" oninput="updatePreview()" placeholder="T√™n hi·ªÉn th·ªã" class="input-modern font-bold">
                            <textarea id="ed-bio" oninput="updatePreview()" placeholder="M√¥ t·∫£ ng·∫Øn" rows="2" class="input-modern resize-none text-sm"></textarea>
                        </div>

                        <!-- Themes -->
                        <div class="space-y-3">
                            <h3 class="font-bold text-xs uppercase text-slate-400">Ch·ªß ƒë·ªÅ</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setTheme('default')" class="h-16 rounded-lg border-2 border-transparent hover:border-brand-500 bg-gradient-to-br from-pink-200 to-pink-400"></button>
                                <button onclick="setTheme('ocean')" class="h-16 rounded-lg border-2 border-transparent hover:border-brand-500 bg-gradient-to-b from-blue-600 to-cyan-400"></button>
                                <button onclick="setTheme('midnight')" class="h-16 rounded-lg border-2 border-transparent hover:border-brand-500 bg-slate-800"></button>
                                <button onclick="setTheme('forest')" class="h-16 rounded-lg border-2 border-transparent hover:border-brand-500 bg-gradient-to-br from-green-700 to-green-400"></button>
                                <button onclick="setTheme('minimal')" class="h-16 rounded-lg border-2 border-transparent hover:border-brand-500 bg-white border-slate-200"></button>
                                <button onclick="setTheme('sunset')" class="h-16 rounded-lg border-2 border-transparent hover:border-brand-500 bg-gradient-to-br from-pink-400 via-purple-400 to-indigo-400"></button>
                            </div>
                        </div>

                        <!-- Button Style -->
                        <div class="space-y-3">
                            <h3 class="font-bold text-xs uppercase text-slate-400">Ki·ªÉu n√∫t</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setButtonStyle('rounded')" class="py-2 border border-slate-200 bg-white rounded-full text-xs font-bold hover:border-brand-500">Tr√≤n</button>
                                <button onclick="setButtonStyle('soft')" class="py-2 border border-slate-200 bg-white rounded-xl text-xs font-bold hover:border-brand-500">Bo g√≥c</button>
                                <button onclick="setButtonStyle('rect')" class="py-2 border border-slate-200 bg-white rounded text-xs font-bold hover:border-brand-500">Vu√¥ng</button>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 3: SETTINGS (Socials) -->
                    <div id="editor-tab-settings" class="editor-tab-content hidden space-y-4">
                        <h3 class="font-bold text-xs uppercase text-slate-400">M·∫°ng x√£ h·ªôi</h3>
                        <div class="space-y-2" id="socials-list">
                            <!-- Injected JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Preview -->
            <div class="flex-1 bg-slate-200 flex items-center justify-center p-4 md:p-8 relative overflow-hidden">
                <div class="w-[340px] h-[680px] bg-black rounded-[48px] border-[8px] border-black shadow-2xl overflow-hidden relative z-10">
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-6 bg-black rounded-b-xl z-20"></div>
                    <iframe id="preview-frame" class="w-full h-full bg-white"></iframe>
                </div>
            </div>
        </div>

        <!-- PUBLIC VIEW TEMPLATE (Hidden, used to render preview & public) -->
        <div id="public-template" class="hidden">
            <style>/* Injected dynamically based on theme */</style>
            <div id="public-body" class="min-h-screen flex flex-col items-center py-12 px-4 transition-colors duration-500">
                <div class="w-full max-w-md text-center animate-slide-up">
                    <img id="p-avatar" class="w-24 h-24 rounded-full object-cover border-4 border-white/50 shadow-xl mx-auto mb-4">
                    <h1 id="p-name" class="text-xl font-bold mb-1 drop-shadow-sm"></h1>
                    <p id="p-bio" class="text-sm opacity-90 mb-6 font-medium max-w-xs mx-auto"></p>
                    
                    <!-- Socials -->
                    <div id="p-socials" class="flex justify-center gap-3 mb-8 flex-wrap"></div>

                    <!-- Links -->
                    <div id="p-links" class="space-y-3 w-full"></div>
                </div>
                <footer class="mt-auto pt-10 text-xs opacity-60 font-bold">Powered by Mewo</footer>
            </div>
        </div>

        <!-- REAL PUBLIC VIEW CONTAINER -->
        <div id="view-public" class="view-section hidden flex-grow min-h-screen"></div>

    </div>

    <!-- MODALS -->
    <div id="modal-create" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs animate-slide-up">
            <h3 class="font-bold text-lg mb-4">T·∫°o Mewo m·ªõi</h3>
            <div class="flex bg-slate-50 border rounded-lg overflow-hidden mb-4"><span class="px-3 py-2 text-slate-500 text-sm border-r">/u/</span><input id="new-slug" placeholder="username" class="flex-1 p-2 bg-transparent outline-none text-sm font-bold lowercase"></div>
            <div class="flex justify-end gap-2"><button onclick="closeModal('modal-create')" class="px-4 py-2 text-sm text-slate-500 font-bold">H·ªßy</button><button onclick="createNewBio()" class="px-4 py-2 bg-brand-600 text-white rounded-lg text-sm font-bold">T·∫°o ngay</button></div>
        </div>
    </div>

    <div id="modal-qr" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4" onclick="closeModal('modal-qr')">
        <div class="bg-white rounded-2xl p-8 w-full max-w-xs animate-slide-up text-center" onclick="event.stopPropagation()">
            <h3 class="font-bold text-xl mb-4 text-slate-900">M√£ QR c·ªßa b·∫°n</h3>
            <img id="qr-image" class="w-48 h-48 mx-auto mb-4 border-2 border-slate-100 rounded-lg">
            <p class="text-sm text-slate-500 mb-6">Qu√©t ƒë·ªÉ truy c·∫≠p trang Bio</p>
            <button onclick="closeModal('modal-qr')" class="w-full py-2 bg-slate-100 text-slate-700 font-bold rounded-lg hover:bg-slate-200">ƒê√≥ng</button>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyAqndpG932fb8RfOUBDAf_Q4R-9llpUJlI", authDomain: "biolink-6e6ee.firebaseapp.com", projectId: "biolink-6e6ee", storageBucket: "biolink-6e6ee.firebasestorage.app", messagingSenderId: "232844523779", appId: "1:232844523779:web:a0bdf6e804892ca5c41136", measurementId: "G-2DSTF8HF5P" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // STATE
        let currentUser = null, currentBioData = null, editingSlug = null;
        let confirmationResult = null; // For Phone Auth
        const socialPlatforms = [
            { id: 'facebook', icon: 'fab fa-facebook', label: 'Facebook' },
            { id: 'instagram', icon: 'fab fa-instagram', label: 'Instagram' },
            { id: 'tiktok', icon: 'fab fa-tiktok', label: 'TikTok' },
            { id: 'youtube', icon: 'fab fa-youtube', label: 'YouTube' },
            { id: 'twitter', icon: 'fab fa-twitter', label: 'Twitter' },
            { id: 'email', icon: 'fas fa-envelope', label: 'Email' }
        ];

        // ROUTER & AUTH
        function handleRoute() {
            const hash = window.location.hash;
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            if (hash.startsWith('#u/')) {
                document.getElementById('view-public').classList.remove('hidden');
                loadPublicBio(hash.split('/')[1]);
            } else if (hash === '#dashboard') {
                if (currentUser) { document.getElementById('view-dashboard').classList.remove('hidden'); loadDashboard(); } 
                else window.location.hash = ''; 
            } else if (hash.startsWith('#edit/')) {
                if (currentUser) { document.getElementById('view-editor').classList.remove('hidden'); loadEditor(hash.split('/')[1]); }
                else window.location.hash = '';
            } else {
                if (currentUser) window.location.hash = '#dashboard';
                else document.getElementById('view-auth').classList.remove('hidden');
            }
        }
        window.addEventListener('hashchange', handleRoute);
        auth.onAuthStateChanged(async user => {
            currentUser = user;
            if (user) { 
                document.getElementById('user-email-display').textContent = user.email || user.phoneNumber || 'User'; 
                // Sync User to DB
                await syncUserToDB(user);
                
                if(!window.location.hash) window.location.hash = '#dashboard'; 
            }
            handleRoute();
        });

        // SYNC USER TO DB
        async function syncUserToDB(user) {
            try {
                await db.collection('users').doc(user.uid).set({
                    email: user.email || user.phoneNumber || 'Anonymous',
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } catch(e) { console.error("Sync User Error:", e); }
        }

        // CAT INTERACTION
        const catContainer = document.getElementById('cat-container');
        document.addEventListener('mousemove', (e) => {
            if(!catContainer) return;
            const rect = catContainer.getBoundingClientRect();
            const dx = (e.clientX - (rect.left + rect.width/2))/25;
            const dy = (e.clientY - (rect.top + rect.height/2))/25;
            const lx = Math.min(Math.max(dx, -5), 5), ly = Math.min(Math.max(dy, -5), 5);
            document.querySelectorAll('.cat-pupil').forEach(p => p.style.transform = `translate(${lx}px, ${ly}px)`);
        });
        document.querySelectorAll('.track-input').forEach(i => { i.onfocus=()=>catContainer.classList.add('loving-it'); i.onblur=()=>catContainer.classList.remove('loving-it'); });
        document.querySelectorAll('.pass-input').forEach(i => { i.onfocus=()=>catContainer.classList.add('covering-eyes'); i.onblur=()=>catContainer.classList.remove('covering-eyes'); });

        // AUTH ACTIONS
        function toggleAuthMode(m) {
            document.getElementById('form-login').classList.toggle('hidden', m !== 'login');
            document.getElementById('form-register').classList.toggle('hidden', m !== 'register');
            document.getElementById('tab-login').classList.toggle('bg-white', m === 'login');
            document.getElementById('tab-login').classList.toggle('text-slate-900', m === 'login');
            document.getElementById('tab-register').classList.toggle('bg-white', m === 'register');
            document.getElementById('tab-register').classList.toggle('text-slate-900', m === 'register');
        }

        // Switch between Main Login and Phone Login Views
        function switchAuthView(view) {
            if(view === 'phone') {
                document.getElementById('auth-main-container').classList.add('hidden');
                document.getElementById('auth-phone-container').classList.remove('hidden');
                // Reset UI
                document.getElementById('phone-step-1').classList.remove('hidden');
                document.getElementById('phone-step-2').classList.add('hidden');
                document.getElementById('otp-input').value = '';
                document.getElementById('btn-send-otp').innerText = 'G·ª≠i m√£ x√°c th·ª±c';
                document.getElementById('btn-send-otp').disabled = false;
                confirmationResult = null;
                setupRecaptcha(); // Init Recaptcha when phone view opens
            } else {
                document.getElementById('auth-phone-container').classList.add('hidden');
                document.getElementById('auth-main-container').classList.remove('hidden');
            }
        }

        async function handleLogin(e) { e.preventDefault(); authAction(auth.signInWithEmailAndPassword, 'login'); }
        async function handleRegister(e) { e.preventDefault(); authAction(auth.createUserWithEmailAndPassword, 'register'); }
        async function authAction(method, type) {
            const email = document.getElementById(type+'-email').value, pass = document.getElementById(type+'-password').value;
            document.getElementById(type+'-loader').classList.remove('hidden');
            try { 
                await method(email, pass); 
                showToast("Th√†nh c√¥ng!", "success"); 
            } catch(e) { 
                showToast(getErrorMessage(e.code), "error"); 
            }
            finally { document.getElementById(type+'-loader').classList.add('hidden'); }
        }

        // Google Login
        async function handleGoogleLogin() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                showToast("ƒêƒÉng nh·∫≠p Google th√†nh c√¥ng!", "success");
            } catch (error) {
                showToast(getErrorMessage(error.code), "error");
            }
        }

        // Phone Login Logic
        function setupRecaptcha() {
            // Clean up existing verifier if any, to avoid "already rendered" issues when switching views
            if (window.recaptchaVerifier) {
                window.recaptchaVerifier.clear();
                window.recaptchaVerifier = null;
            }
            
            // Invisible Recaptcha on the button "G·ª≠i m√£ x√°c th·ª±c"
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('btn-send-otp', {
                'size': 'invisible',
                'callback': (response) => {
                    console.log("Recaptcha Verified");
                    // No need to call sendOTP() here explicitly because signInWithPhoneNumber will continue
                }
            });
        }

        async function sendOTP() {
            const rawPhone = document.getElementById('phone-input').value.replace(/[^0-9]/g, '');
            
            if (rawPhone.length < 9) {
                return showToast("S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá", "error");
            }

            // ƒê·ªãnh d·∫°ng s·ªë ƒëi·ªán tho·∫°i (M·∫∑c ƒë·ªãnh +84)
            const phoneNumber = '+84' + rawPhone.replace(/^0+/, ''); 
            const appVerifier = window.recaptchaVerifier;
            
            const btn = document.getElementById('btn-send-otp');
            const originalText = btn.innerText;
            btn.innerText = "ƒêang g·ª≠i...";
            btn.disabled = true;

            try {
                // H√†m signInWithPhoneNumber c·ªßa Compat SDK (T∆∞∆°ng ƒë∆∞∆°ng code b·∫°n g·ª≠i)
                const confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, appVerifier);
                
                // L∆∞u k·∫øt qu·∫£ x√°c th·ª±c v√†o window nh∆∞ y√™u c·∫ßu
                window.confirmationResult = confirmationResult;
                
                showToast("ƒê√£ g·ª≠i m√£ OTP!", "success");
                
                // Chuy·ªÉn giao di·ªán sang nh·∫≠p OTP
                document.getElementById('phone-step-1').classList.add('hidden');
                document.getElementById('phone-step-2').classList.remove('hidden');
                
            } catch (error) {
                console.error("SMS Error:", error);
                showToast(getErrorMessage(error.code), "error");
                
                // Reset l·∫°i ƒë·ªÉ th·ª≠ l·∫°i
                btn.innerText = originalText;
                btn.disabled = false;
                if(window.recaptchaVerifier) {
                    window.recaptchaVerifier.clear();
                    setupRecaptcha();
                }
            }
        }

        async function verifyOTP() {
            const code = document.getElementById('otp-input').value;
            
            if(!code) return showToast("Vui l√≤ng nh·∫≠p m√£ OTP", "error");
            if(!window.confirmationResult) return showToast("Vui l√≤ng g·ª≠i m√£ x√°c th·ª±c tr∆∞·ªõc", "error");

            try {
                // ConfirmationResult.confirm(code)
                const result = await window.confirmationResult.confirm(code);
                
                // User signed in successfully
                const user = result.user;
                console.log("User signed in:", user);
                
                showToast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!", "success");
                // Auth listener handles redirection
            } catch (error) {
                // User couldn't sign in (bad verification code?)
                console.error("OTP Error:", error);
                showToast("M√£ x√°c th·ª±c kh√¥ng ƒë√∫ng ho·∫∑c ƒë√£ h·∫øt h·∫°n", "error");
            }
        }

        function handleLogout() { auth.signOut(); showToast("ƒê√£ ƒëƒÉng xu·∫•t"); }

        // Vietnamese Error Mapping
        function getErrorMessage(code) {
            switch (code) {
                case 'auth/email-already-in-use': return "Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng.";
                case 'auth/invalid-email': return "Email kh√¥ng h·ª£p l·ªá.";
                case 'auth/user-not-found': return "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i.";
                case 'auth/wrong-password': return "M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.";
                case 'auth/weak-password': return "M·∫≠t kh·∫©u qu√° y·∫øu (t·ªëi thi·ªÉu 6 k√Ω t·ª±).";
                case 'auth/too-many-requests': return "Qu√° nhi·ªÅu y√™u c·∫ßu. Vui l√≤ng th·ª≠ l·∫°i sau.";
                case 'auth/invalid-verification-code': return "M√£ OTP kh√¥ng ƒë√∫ng.";
                case 'auth/popup-closed-by-user': return "ƒê√£ h·ªßy ƒëƒÉng nh·∫≠p.";
                case 'auth/captcha-check-failed': return "L·ªói x√°c th·ª±c Captcha. Vui l√≤ng th·ª≠ l·∫°i.";
                case 'auth/invalid-phone-number': return "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá.";
                case 'auth/missing-phone-number': return "Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i.";
                case 'auth/quota-exceeded': return "H·∫øt h·∫°n ng·∫°ch SMS. Vui l√≤ng th·ª≠ l·∫°i sau.";
                case 'auth/operation-not-allowed': return "L·ªói: B·∫°n ch∆∞a b·∫≠t ph∆∞∆°ng th·ª©c ƒëƒÉng nh·∫≠p n√†y trong Firebase Console.";
                default: return "L·ªói: " + code;
            }
        }

        // DASHBOARD
        async function loadDashboard() {
            const list = document.getElementById('bio-list'), loader = document.getElementById('dashboard-loader');
            list.innerHTML = ''; loader.classList.remove('hidden');
            try {
                const snap = await db.collection('bios').where('ownerId', '==', currentUser.uid).get();
                loader.classList.add('hidden');
                if (snap.empty) { list.innerHTML = `<div class="col-span-full text-center py-10 text-slate-400">B·∫°n ch∆∞a c√≥ trang Bio n√†o.</div>`; return; }
                snap.forEach(doc => {
                    const d = doc.data();
                    list.innerHTML += `
                    <div class="bg-white p-5 rounded-xl shadow-sm border hover:shadow-md transition">
                        <div class="flex items-center gap-3 mb-3">
                            <img src="${d.profile.avatar || 'https://ui-avatars.com/api/?background=random'}" class="w-12 h-12 rounded-full border">
                            <div class="overflow-hidden"><h3 class="font-bold truncate">${d.profile.name}</h3><span class="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">/${doc.id}</span></div>
                        </div>
                        <div class="flex justify-between items-center text-xs text-slate-400 mb-4 border-t pt-2">
                            <span><i class="fas fa-eye"></i> ${d.views || 0} views</span>
                            <span>${d.links?.length || 0} links</span>
                        </div>
                        <div class="flex gap-2">
                            <a href="#edit/${doc.id}" class="flex-1 bg-slate-900 text-white text-center py-2 rounded-lg text-sm font-bold hover:bg-slate-800">S·ª≠a</a>
                            <button onclick="copyToClipboard('${window.location.origin}${window.location.pathname}#u/${doc.id}')" class="px-3 bg-slate-100 rounded-lg hover:bg-slate-200"><i class="fas fa-copy text-slate-600"></i></button>
                            <a href="#u/${doc.id}" target="_blank" class="px-3 bg-slate-100 rounded-lg hover:bg-slate-200 flex items-center"><i class="fas fa-external-link-alt text-slate-600"></i></a>
                        </div>
                    </div>`;
                });
            } catch(e) { showToast(e.message, 'error'); }
        }
        function openCreateModal() { document.getElementById('modal-create').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        // NEW ROBUST createNewBio
        async function createNewBio() {
            const slug = document.getElementById('new-slug').value.trim().toLowerCase();
            // Validation
            const regex = /^[a-z0-9-]+$/;
            if (!slug || slug.length < 3) return showToast("T√™n ƒë∆∞·ªùng d·∫´n qu√° ng·∫Øn (t·ªëi thi·ªÉu 3 k√Ω t·ª±)", "error");
            if (!regex.test(slug)) return showToast("Ch·ªâ d√πng ch·ªØ th∆∞·ªùng, s·ªë v√† g·∫°ch ngang", "error");

            try {
                // Check if slug exists
                const docRef = db.collection('bios').doc(slug);
                const doc = await docRef.get();
                if (doc.exists) {
                    return showToast("ƒê∆∞·ªùng d·∫´n n√†y ƒë√£ c√≥ ng∆∞·ªùi s·ª≠ d·ª•ng!", "error");
                }

                // Create new bio
                await docRef.set({
                    ownerId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    profile: { 
                        name: "Ng∆∞·ªùi d√πng m·ªõi", 
                        bio: "Ch√†o m·ª´ng ƒë·∫øn v·ªõi Mewo!", 
                        avatar: `https://ui-avatars.com/api/?name=${slug}&background=random` 
                    },
                    links: [],
                    products: [],
                    theme: { id: 'default', buttonStyle: 'rounded' },
                    socials: {}, 
                    views: 0
                });
                
                closeModal('modal-create'); 
                showToast("T·∫°o trang th√†nh c√¥ng!", "success"); 
                loadDashboard();
            } catch(e) { 
                console.error(e);
                showToast("L·ªói: " + e.message, "error"); 
            }
        }

        // EDITOR
        async function loadEditor(slug) {
            editingSlug = slug;
            document.getElementById('editor-url-display').textContent = `${window.location.origin}/#u/${slug}`;
            document.getElementById('live-preview-link').href = `#u/${slug}`;
            try {
                const doc = await db.collection('bios').doc(slug).get();
                if(!doc.exists || doc.data().ownerId !== currentUser.uid) return window.location.hash = '#dashboard';
                currentBioData = doc.data();
                if(!currentBioData.theme) currentBioData.theme = { id: 'default', buttonStyle: 'rounded' };
                if(!currentBioData.socials) currentBioData.socials = {};
                
                // Fill Inputs
                document.getElementById('ed-name').value = currentBioData.profile.name;
                document.getElementById('ed-bio').value = currentBioData.profile.bio;
                document.getElementById('ed-avatar').value = currentBioData.profile.avatar;
                
                renderSocialsInput();
                renderEditorLinks();
                switchEditorTab('links');
                updatePreview();
            } catch(e) { showToast(e.message, 'error'); }
        }

        function switchEditorTab(tab) {
            document.querySelectorAll('.editor-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`editor-tab-${tab}`).classList.remove('hidden');
            ['links','appearance','settings'].forEach(t => {
                const btn = document.getElementById(`tab-editor-${t}`);
                if(t===tab) btn.className = "flex-1 py-2 text-sm font-bold border-b-2 border-brand-600 text-brand-600";
                else btn.className = "flex-1 py-2 text-sm font-medium text-slate-500 hover:text-slate-800";
            });
        }

        function renderEditorLinks() {
            const list = document.getElementById('ed-links-list'); list.innerHTML = '';
            currentBioData.links.forEach((l, i) => {
                list.innerHTML += `
                <div class="bg-white p-3 rounded-lg border shadow-sm group relative">
                    <div class="absolute top-2 right-2 flex gap-2">
                        <label class="text-xs flex items-center gap-1 cursor-pointer bg-slate-50 px-2 py-1 rounded"><input type="checkbox" ${l.highlight?'checked':''} onchange="updateLink(${i},'highlight',this.checked)"> N·ªïi b·∫≠t</label>
                        <button onclick="removeLink(${i})" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                    <input value="${l.title}" oninput="updateLink(${i},'title',this.value)" class="font-bold w-full bg-transparent outline-none mb-1" placeholder="Ti√™u ƒë·ªÅ">
                    <input value="${l.url}" oninput="updateLink(${i},'url',this.value)" class="text-xs w-full bg-transparent outline-none text-blue-500" placeholder="https://...">
                </div>`;
            });
        }
        function addLinkItem() { currentBioData.links.push({ title: "Link M·ªõi", url: "#", highlight: false }); renderEditorLinks(); updatePreview(); }
        function removeLink(i) { currentBioData.links.splice(i, 1); renderEditorLinks(); updatePreview(); }
        function updateLink(i, k, v) { currentBioData.links[i][k] = v; updatePreview(); }
        
        function renderSocialsInput() {
            const list = document.getElementById('socials-list'); list.innerHTML = '';
            socialPlatforms.forEach(p => {
                const val = currentBioData.socials[p.id] || '';
                list.innerHTML += `<div class="flex items-center gap-2 border rounded-lg px-3 py-2 bg-slate-50"><i class="${p.icon} text-slate-400 w-5"></i><input type="text" value="${val}" oninput="updateSocial('${p.id}', this.value)" placeholder="${p.label} URL" class="bg-transparent outline-none text-sm w-full"></div>`;
            });
        }
        function updateSocial(id, val) { currentBioData.socials[id] = val; updatePreview(); }
        
        function setTheme(id) { currentBioData.theme.id = id; updatePreview(); }
        function setButtonStyle(style) { currentBioData.theme.buttonStyle = style; updatePreview(); }

        function updatePreview() {
            // Update Data from Inputs
            currentBioData.profile.name = document.getElementById('ed-name').value;
            currentBioData.profile.bio = document.getElementById('ed-bio').value;
            currentBioData.profile.avatar = document.getElementById('ed-avatar').value;
            document.getElementById('editor-avatar-preview').src = currentBioData.profile.avatar;

            // Render Preview Frame
            const frame = document.getElementById('preview-frame');
            const doc = frame.contentDocument || frame.contentWindow.document;
            doc.open();
            doc.write(generatePublicHTML(currentBioData, true));
            doc.close();
        }

        async function saveCurrentBio() {
            try { await db.collection('bios').doc(editingSlug).update(currentBioData); showToast("ƒê√£ l∆∞u!", "success"); } catch(e) { showToast(e.message, 'error'); }
        }
        function goToDashboard() { window.location.hash = '#dashboard'; }
        function showQRCode() {
            const url = `${window.location.origin}${window.location.pathname}#u/${editingSlug}`;
            document.getElementById('qr-image').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
            document.getElementById('modal-qr').classList.remove('hidden');
        }

        // PUBLIC RENDERER
        async function loadPublicBio(slug) {
            const container = document.getElementById('view-public');
            container.innerHTML = '<div class="flex justify-center items-center h-screen"><div class="w-10 h-10 border-4 border-slate-200 border-t-brand-600 rounded-full animate-spin"></div></div>';
            try {
                const docRef = db.collection('bios').doc(slug);
                const doc = await docRef.get();
                if(!doc.exists) { container.innerHTML = '<div class="text-center py-20">Trang kh√¥ng t·ªìn t·∫°i</div>'; return; }
                
                // Analytics: Increment view
                docRef.update({ views: firebase.firestore.FieldValue.increment(1) });

                const data = doc.data();
                container.innerHTML = generatePublicHTML(data, false);
            } catch(e) { container.innerHTML = 'L·ªói t·∫£i trang'; }
        }

        function generatePublicHTML(data, isPreview) {
            const theme = data.theme || { id: 'default', buttonStyle: 'rounded' };
            const btnStyleMap = {
                'rounded': 'rounded-full',
                'rect': 'rounded-md',
                'soft': 'rounded-2xl'
            };
            const radiusClass = btnStyleMap[theme.buttonStyle] || 'rounded-full';
            
            // Generate Links with Staggered Animation
            const linksHtml = (data.links || []).map((l, i) => `
                <a href="${l.url}" target="_blank" class="block group relative transition-all duration-300 hover:-translate-y-1 hover:scale-[1.01] active:scale-95 mb-4" style="animation-delay: ${i * 100}ms">
                    ${l.highlight ? '<div class="absolute -inset-0.5 bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500 blur opacity-75 group-hover:opacity-100 transition duration-1000 ' + radiusClass + '"></div>' : ''}
                    <div class="relative w-full p-4 flex items-center justify-between transition-all duration-300 ${l.highlight ? 'bg-white text-slate-900' : 'bg-white/90 hover:bg-white text-slate-800'} backdrop-blur-md shadow-sm border border-white/40 hover:shadow-md ${radiusClass}">
                        ${l.thumbnail ? `<img src="${l.thumbnail}" class="w-10 h-10 object-cover ${radiusClass} absolute left-3">` : ''} 
                        <div class="w-full text-center px-8">
                            <span class="font-bold text-sm sm:text-base tracking-wide">${l.title}</span>
                        </div>
                        <div class="absolute right-4 opacity-0 group-hover:opacity-100 transition-opacity text-sm"><i class="fas fa-external-link-alt"></i></div>
                    </div>
                </a>
            `).join('');

            // Generate Socials
            let socialsHtml = '';
            if (data.socials) {
                socialsHtml = socialPlatforms.map(p => {
                    if (data.socials[p.id]) return `
                        <a href="${data.socials[p.id]}" target="_blank" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/20 hover:bg-white/40 backdrop-blur-sm transition-all transform hover:scale-110 border border-white/20 text-white shadow-sm">
                            <i class="${p.icon} text-lg"></i>
                        </a>`;
                    return '';
                }).join('');
            }

            // Return full HTML string
            return `
                <!DOCTYPE html>
                <html lang="vi">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Be Vietnam Pro', sans-serif; margin:0; min-height:100vh; overflow-x: hidden; }
                        
                        /* Scrollbar for preview */
                        ::-webkit-scrollbar { width: 0px; background: transparent; }
                        
                        /* Animations */
                        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
                        .animate-enter { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
                        
                        /* Theme Backgrounds */
                        .theme-bg-default { background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); background-size: 400% 400%; animation: gradientBG 15s ease infinite; color: white; }
                        .theme-bg-ocean { background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); color: white; }
                        .theme-bg-midnight { background-color: #000000; background-image: radial-gradient(#333 1px, transparent 1px); background-size: 30px 30px; color: white; }
                        .theme-bg-forest { background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%); color: white; }
                        .theme-bg-minimal { background-color: #f3f4f6; color: #1f2937; }
                        .theme-bg-sunset { background: linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%); color: #1e293b; }
                        
                        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
                        
                        /* Glass overrides */
                        .glass-btn { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
                        .theme-bg-midnight .glass-btn { background: rgba(30, 41, 59, 0.8); color: white; border: 1px solid rgba(255, 255, 255, 0.1); }
                        .theme-bg-midnight .glass-btn:hover { background: rgba(30, 41, 59, 1); }
                    </style>
                </head>
                <body class="theme-bg-${theme.id} w-full flex flex-col items-center">
                    <div class="w-full max-w-lg px-6 py-12 flex flex-col items-center min-h-screen">
                        
                        <!-- Profile -->
                        <div class="text-center mb-8 animate-enter" style="animation-delay: 0ms">
                            <div class="relative w-28 h-28 mx-auto mb-4 group">
                                <div class="absolute inset-0 bg-white/30 rounded-full blur-md group-hover:blur-lg transition-all duration-500"></div>
                                <img src="${data.profile.avatar}" class="relative w-full h-full rounded-full object-cover border-4 border-white/50 shadow-2xl" 
                                     onerror="this.src='https://ui-avatars.com/api/?name=Mewo&background=random'">
                            </div>
                            <h1 class="text-2xl font-extrabold mb-2 drop-shadow-md tracking-tight">${data.profile.name}</h1>
                            <p class="text-sm font-medium opacity-90 max-w-xs mx-auto leading-relaxed whitespace-pre-line">${data.profile.bio}</p>
                        </div>

                        <!-- Socials -->
                        <div class="flex gap-4 mb-10 flex-wrap justify-center animate-enter" style="animation-delay: 100ms">
                            ${socialsHtml}
                        </div>

                        <!-- Links -->
                        <div class="w-full space-y-4">
                            ${linksHtml}
                        </div>

                        ${!isPreview ? `
                        <footer class="mt-auto pt-16 pb-4 text-center animate-enter" style="animation-delay: 500ms">
                            <a href="#" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-sm transition-colors text-xs font-bold opacity-80 hover:opacity-100">
                                <i class="fas fa-cat"></i> Created with Mewo
                            </a>
                        </footer>` : ''}
                    </div>
                </body>
                </html>
            `;
        }

        // UTILS
        function showToast(msg, type='info') {
            const t = document.createElement('div'); t.className = 'toast'; t.innerHTML = `<i class="fas fa-${type==='success'?'check-circle text-green-500':type==='error'?'exclamation-circle text-red-500':'info-circle text-blue-500'} text-lg"></i><span>${msg}</span>`;
            document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 3000);
        }
        function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => showToast("ƒê√£ copy link!", "success")); }
        document.addEventListener('DOMContentLoaded', handleRoute);
    </script>
</body>
</html>
